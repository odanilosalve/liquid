name: Deploy

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
      - '.github/workflows/ci.yml'  # Ignora apenas mudanças no CI
      # Nota: Mudanças em .github/workflows/deploy.yml NÃO são ignoradas,
      # permitindo que o deploy execute quando o próprio workflow é atualizado
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Serverless
        run: npm install -g serverless@3

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate AWS credentials
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "::error::AWS_ACCESS_KEY_ID secret is not set"
            echo "Please configure it in: Settings → Secrets and variables → Actions"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "::error::AWS_SECRET_ACCESS_KEY secret is not set"
            echo "Please configure it in: Settings → Secrets and variables → Actions"
            exit 1
          fi
          # Check for common issues with credentials
          ACCESS_KEY_LENGTH=${#AWS_ACCESS_KEY_ID}
          if [ "$ACCESS_KEY_LENGTH" -lt 16 ] || [ "$ACCESS_KEY_LENGTH" -gt 128 ]; then
            echo "::warning::AWS_ACCESS_KEY_ID length seems unusual: $ACCESS_KEY_LENGTH characters"
          fi
          echo "✓ AWS credentials secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS credentials
        run: |
          echo "Verifying AWS credentials..."
          if aws sts get-caller-identity; then
            echo "✓ AWS credentials are valid"
            aws sts get-caller-identity
          else
            echo "::error::Failed to authenticate with AWS"
            echo ""
            echo "Possible causes:"
            echo "1. AWS_ACCESS_KEY_ID or AWS_SECRET_ACCESS_KEY are incorrect"
            echo "2. The credentials have expired or been revoked"
            echo "3. Extra spaces or special characters in the secrets"
            echo "4. The IAM user doesn't have necessary permissions"
            echo ""
            echo "To fix:"
            echo "1. Go to AWS IAM → Users → Your user → Security credentials"
            echo "2. Verify or create new access keys"
            echo "3. Update the secrets in GitHub: Settings → Secrets and variables → Actions"
            echo "4. Make sure to copy the values exactly (no spaces, no quotes)"
            exit 1
          fi

      - name: Deploy to AWS
        working-directory: ./backend
        run: |
          STAGE=${{ github.event.inputs.stage || 'dev' }}
          serverless deploy --stage $STAGE
        env:
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          EXCHANGE_RATE_API_URL: ${{ secrets.EXCHANGE_RATE_API_URL || 'https://api.exchangerate-api.com/v4/latest' }}
          ALLOWED_ORIGIN: ${{ secrets.ALLOWED_ORIGIN || '*' }}

      - name: Deployment summary
        run: |
          echo " Backend deployed successfully to stage: ${{ github.event.inputs.stage || 'dev' }}"
          echo " Check your API endpoints in AWS API Gateway"

