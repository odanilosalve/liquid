name: Deploy

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
      - '.github/workflows/ci.yml'  # Ignora apenas mudanças no CI
      # Nota: Mudanças em .github/workflows/deploy.yml NÃO são ignoradas,
      # permitindo que o deploy execute quando o próprio workflow é atualizado
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Serverless
        run: npm install -g serverless@3

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate AWS credentials format
        run: |
          echo "Validating AWS credentials format..."
          
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "::error::AWS_ACCESS_KEY_ID secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "::error::AWS_SECRET_ACCESS_KEY secret is not set"
            exit 1
          fi
          
          # Check Access Key ID format (should start with AKIA and be ~20 chars)
          ACCESS_KEY="${{ secrets.AWS_ACCESS_KEY_ID }}"
          ACCESS_KEY_LENGTH=${#ACCESS_KEY}
          
          if [[ ! "$ACCESS_KEY" =~ ^AKIA[0-9A-Z]{16}$ ]]; then
            echo "::warning::AWS_ACCESS_KEY_ID format may be incorrect"
            echo "Expected format: AKIA followed by 16 alphanumeric characters"
            echo "Current length: $ACCESS_KEY_LENGTH characters"
            echo "First 4 chars: ${ACCESS_KEY:0:4}"
          else
            echo "✓ AWS_ACCESS_KEY_ID format looks correct"
          fi
          
          # Check Secret Access Key format (should be ~40 chars, base64-like)
          SECRET_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          SECRET_KEY_LENGTH=${#SECRET_KEY}
          
          if [ "$SECRET_KEY_LENGTH" -lt 30 ] || [ "$SECRET_KEY_LENGTH" -gt 50 ]; then
            echo "::warning::AWS_SECRET_ACCESS_KEY length seems unusual: $SECRET_KEY_LENGTH characters"
            echo "Expected length: ~40 characters"
          else
            echo "✓ AWS_SECRET_ACCESS_KEY length looks correct"
          fi
          
          # Check for common issues
          if [[ "$ACCESS_KEY" =~ [[:space:]] ]]; then
            echo "::error::AWS_ACCESS_KEY_ID contains whitespace - this will cause authentication to fail"
            exit 1
          fi
          
          if [[ "$SECRET_KEY" =~ [[:space:]] ]]; then
            echo "::error::AWS_SECRET_ACCESS_KEY contains whitespace - this will cause authentication to fail"
            exit 1
          fi
          
          echo "✓ AWS credentials format validation passed"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS credentials
        run: |
          echo "Verifying AWS credentials..."
          if aws sts get-caller-identity; then
            echo "✓ AWS credentials are valid"
            aws sts get-caller-identity
          else
            echo "::error::Failed to authenticate with AWS"
            echo ""
            echo "Possible causes:"
            echo "1. AWS_ACCESS_KEY_ID or AWS_SECRET_ACCESS_KEY are incorrect"
            echo "2. The credentials have expired or been revoked"
            echo "3. Extra spaces or special characters in the secrets"
            echo "4. The IAM user doesn't have necessary permissions"
            echo ""
            echo "To fix:"
            echo "1. Go to AWS IAM → Users → Your user → Security credentials"
            echo "2. Verify or create new access keys"
            echo "3. Update the secrets in GitHub: Settings → Secrets and variables → Actions"
            echo "4. Make sure to copy the values exactly (no spaces, no quotes)"
            exit 1
          fi

      - name: Deploy to AWS
        working-directory: ./backend
        run: |
          STAGE=${{ github.event.inputs.stage || 'dev' }}
          serverless deploy --stage $STAGE
        env:
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          EXCHANGE_RATE_API_URL: ${{ secrets.EXCHANGE_RATE_API_URL || 'https://api.exchangerate-api.com/v4/latest' }}
          ALLOWED_ORIGIN: ${{ secrets.ALLOWED_ORIGIN || '*' }}

      - name: Deployment summary
        run: |
          echo " Backend deployed successfully to stage: ${{ github.event.inputs.stage || 'dev' }}"
          echo " Check your API endpoints in AWS API Gateway"

